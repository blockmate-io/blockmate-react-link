{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["const EVENT_MESSAGES = {\n  linkConnect: ``,\n  verifyPhone: `verify-phone`,\n  changePhone: `change-phone`,\n  enableTransfer: `enable-transfer`,\n  transferAssets: `transfer-assets`,\n  cryptoSavings: `crypto-savings`,\n  withdrawAssets: `withdraw-assets`,\n  close: 'blockmate-iframe-close',\n  redirect: 'redirect',\n  deposit: 'deposit',\n}\n\nconst TRUSTED_ORIGINS = [\n  'https://link.blockmate.io',\n  'https://link-dev-ovh.blockmate.io',\n  'https://link-cs.blockmate.io',\n  'http://localhost:3000'\n];\n\nexport const handleOpen = (message = '', accountId, oauthConnectedAccount, extraUrlParams) => {\n  if (!Object.keys(EVENT_MESSAGES).includes(message)) {\n    message = 'linkConnect';\n  }\n  window.parent.postMessage({ type: message, accountId, oauthConnectedAccount, extraUrlParams }, '*');\n};\n\nexport const handleClose = (endResult) => {\n  window.parent.postMessage({ type: 'close', endResult }, '*');\n};\n\nexport const handleRedirect = (targetUrl) => {\n  window.parent.postMessage({ type: 'redirect', targetUrl }, '*');\n};\n\nexport const LinkModal = ({\n  jwt,\n  url = 'https://link.blockmate.io/',\n  cleanupActions = {},\n  additionalUrlParams= null,\n  merchantInfo = {\n    description: 'ExampleMerchant',\n    icon: 'https://api.blockmate.io/v1/onchain/static/bitcoin.png',\n  },\n}) => {\n  const OAUTH_QUERY_PARAM = 'oauthConnectedAccount';\n  const OAUTH_LOCAL_STORAGE_KEY = 'oauth_connected_account';\n  const DEPOSIT_OAUTH_SUCCESS_STEP = 'oauth_success';\n  let oauthPollingInterval;\n\n  // For oauth\n  const startOauthSuccessPolling = () => {\n    oauthPollingInterval = setInterval(() => {\n      const params = new URLSearchParams(window.location.search);\n      const maybeOauthConnectedAccount = params.get(OAUTH_QUERY_PARAM);\n      if (maybeOauthConnectedAccount) {\n        params.delete(OAUTH_QUERY_PARAM);\n        localStorage.setItem(OAUTH_LOCAL_STORAGE_KEY, maybeOauthConnectedAccount);\n        // This will redirect the user to the same page without the query param, but with state in localStorage\n        location.replace(`${window.location.origin}${window.location.pathname}?${params.toString()}`);\n      }\n    }, 500);\n  };\n\n  // For oauth\n  const startLocalStoragePolling = () => {\n    const localStoragePollingInterval = setInterval(() => {\n      const oauthConnectedAccount = localStorage.getItem(OAUTH_LOCAL_STORAGE_KEY);\n      const currentUrl = new URL(window.location.href);\n      const oauthQueryParamDeletedAlready = !currentUrl.searchParams.has(OAUTH_QUERY_PARAM);\n      if (oauthConnectedAccount && oauthQueryParamDeletedAlready) {\n        let path = EVENT_MESSAGES.linkConnect;\n        let step;\n        if (currentUrl.searchParams.has('deposit_id')) {\n          path = EVENT_MESSAGES.deposit;\n          step = DEPOSIT_OAUTH_SUCCESS_STEP;\n        }\n        createIframe(\n          new URL(path, url).href,\n          undefined,\n          oauthConnectedAccount,\n          step,\n        );\n        localStorage.removeItem(OAUTH_LOCAL_STORAGE_KEY);\n      }\n    }, 500);\n  };\n\n  const body = document.querySelector('body');\n  const iframeStyle =\n    'display:block; position:fixed; width:100%; height:100%; z-index:100; border:none; top:0; right:0';\n\n  const createIframe = (url, accountId, oauthConnectedAccount, step) => {\n    const iframeId = 'link-iframe';\n    const existingIframe = document.getElementById(iframeId);\n    if (!existingIframe) {\n      const parentUrlEncoded = encodeURIComponent(window.location.href);\n      const merchantUrlParams = [['merchantDescription', merchantInfo.description], ['merchantIcon', encodeURIComponent(merchantInfo.icon)]]\n        .filter(([_, value]) => value);\n      const urlParamsArray = [\n        ['jwt', jwt],\n        ['accountId', accountId],\n        ['parentUrlEncoded', parentUrlEncoded],\n        ['step', step],\n        ...merchantUrlParams,\n        ...Object.entries(additionalUrlParams ?? {})\n      ].filter(([key, value]) => value);\n      let urlParams = urlParamsArray.map(([key, value]) => `${key}=${value}`).join('&');\n      if (url.includes('?')) {\n        urlParams = `&${urlParams}`;\n      } else if (urlParams.length > 0) {\n        urlParams = `?${urlParams}`;\n      }\n      let urlWithParams = `${url}${urlParams}`;\n      if (oauthConnectedAccount) {\n        urlWithParams += `&${OAUTH_QUERY_PARAM}=${oauthConnectedAccount}`;\n      }\n\n      const iframe = document.createElement('iframe');\n      iframe.setAttribute('src', urlWithParams);\n      iframe.setAttribute('style', iframeStyle);\n      iframe.setAttribute('id', iframeId);\n      iframe.setAttribute('allow', 'camera');  // For QR-code scanning\n      body.appendChild(iframe);\n    }\n  };\n\n  const removeIframe = (event) => {\n    const iframe = document.querySelector('#link-iframe');\n    if (iframe) {\n      body.removeChild(iframe);\n    }\n    if (event.data.url) {\n      window.location = event.data.url;\n    }\n\n    const endResult = event?.data?.endResult\n    if (endResult && cleanupActions[endResult]) {\n      cleanupActions[endResult]();\n    }\n  };\n\n  startOauthSuccessPolling();\n  startLocalStoragePolling();\n\n  window.onmessage = function (event) {\n    if (!Object.hasOwn(EVENT_MESSAGES, event.data.type)) {\n      return null;\n    }\n\n    // These actions can only be called from within the iframe, check origin as they can perform redirects of the parent\n    if (['close', 'redirect'].includes(event?.data?.type)) {\n      if (!TRUSTED_ORIGINS.includes(event.origin)) {\n        return null;\n      }\n    }\n\n    if (event?.data?.type === 'close') {\n      removeIframe(event);\n    } else if (event?.data?.type === 'redirect') {\n      window.location.replace(event.data.targetUrl);\n    } else {\n      let urlParams = Object.entries((event.data.extraUrlParams ?? {})).map(([key, value]) => `${key}=${value}`).join('&');\n      if (urlParams.length > 0) {\n        urlParams = `?${urlParams}`;\n      }\n      createIframe(\n        new URL(`${EVENT_MESSAGES[event.data.type]}${urlParams}`, url).href,\n        event.data.accountId,\n        event.data.oauthConnectedAccount,\n      );\n    }\n  };\n\n  return null;\n};\n"],"names":["EVENT_MESSAGES","linkConnect","verifyPhone","changePhone","enableTransfer","transferAssets","cryptoSavings","withdrawAssets","close","redirect","deposit","TRUSTED_ORIGINS","handleOpen","message","accountId","oauthConnectedAccount","extraUrlParams","Object","keys","includes","window","parent","postMessage","type","handleClose","endResult","handleRedirect","targetUrl","LinkModal","_ref","jwt","_ref$url","url","_ref$cleanupActions","cleanupActions","_ref$additionalUrlPar","additionalUrlParams","_ref$merchantInfo","merchantInfo","description","icon","OAUTH_QUERY_PARAM","OAUTH_LOCAL_STORAGE_KEY","DEPOSIT_OAUTH_SUCCESS_STEP","oauthPollingInterval","startOauthSuccessPolling","setInterval","params","URLSearchParams","location","search","maybeOauthConnectedAccount","get","localStorage","setItem","replace","origin","pathname","toString","startLocalStoragePolling","localStoragePollingInterval","getItem","currentUrl","URL","href","oauthQueryParamDeletedAlready","searchParams","has","path","step","createIframe","undefined","removeItem","body","document","querySelector","iframeStyle","iframeId","existingIframe","getElementById","parentUrlEncoded","encodeURIComponent","merchantUrlParams","filter","_ref2","value","urlParamsArray","concat","entries","_ref3","urlParams","map","_ref4","key","join","length","urlWithParams","iframe","createElement","setAttribute","appendChild","removeIframe","event","_event$data","removeChild","data","onmessage","_event$data2","_event$data3","_event$data4","hasOwn","_event$data$extraUrlP","_ref5"],"mappings":"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"}