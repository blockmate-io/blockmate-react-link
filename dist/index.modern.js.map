{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["const EVENT_MESSAGES = {\n  linkConnect: ``,\n  verifyPhone: `verify-phone`,\n  changePhone: `change-phone`,\n  enableTransfer: `enable-transfer`,\n  transferAssets: `transfer-assets`,\n  cryptoSavings: `crypto-savings`,\n  withdrawAssets: `withdraw-assets`,\n  close: 'blockmate-iframe-close',\n  redirect: 'redirect'\n}\n\nexport const handleOpen = (message = '', accountId, oauthConnectedAccount) => {\n  if (!Object.keys(EVENT_MESSAGES).includes(message)) {\n    message = EVENT_MESSAGES.linkConnect;\n  }\n  window.parent.postMessage({ type: message, accountId, oauthConnectedAccount }, '*');\n}\n\nexport const handleClose = (endResult) => {\n  window.parent.postMessage({ type: EVENT_MESSAGES.close, endResult }, '*');\n}\n\nexport const handleRedirect = (targetUrl) => {\n  window.parent.postMessage({ type: EVENT_MESSAGES.redirect, targetUrl }, '*');\n};\n\nexport const LinkModal = ({\n  jwt,\n  url = 'https://link.blockmate.io/',\n  cleanupActions = {},\n  additionalUrlParams= null\n}) => {\n  const OAUTH_QUERY_PARAM = 'oauthConnectedAccount';\n  const OAUTH_LOCAL_STORAGE_KEY = 'oauth_connected_account';\n  let oauthPollingInterval;\n\n  // For oauth\n  const startOauthSuccessPolling = () => {\n    oauthPollingInterval = setInterval(() => {\n      const params = new URLSearchParams(window.location.search);\n      const maybeOauthConnectedAccount = params.get(OAUTH_QUERY_PARAM);\n      if (maybeOauthConnectedAccount) {\n        params.delete(OAUTH_QUERY_PARAM);\n        localStorage.setItem(OAUTH_LOCAL_STORAGE_KEY, maybeOauthConnectedAccount);\n        // This will redirect the user to the same page without the query param, but with state in localStorage\n        location.replace(`${window.location.origin}${window.location.pathname}?${params.toString()}`);\n      }\n    }, 500);\n  };\n\n  // For oauth\n  const startLocalStoragePolling = () => {\n    const localStoragePollingInterval = setInterval(() => {\n      const oauthConnectedAccount = localStorage.getItem(OAUTH_LOCAL_STORAGE_KEY);\n      const currentUrl = new URL(window.location.href);\n      const oauthQueryParamDeletedAlready = !currentUrl.searchParams.has(OAUTH_QUERY_PARAM);\n      if (oauthConnectedAccount && oauthQueryParamDeletedAlready) {\n        createIframe(\n          new URL(EVENT_MESSAGES.linkConnect, url).href,\n          undefined,\n          oauthConnectedAccount\n        );\n        localStorage.removeItem(OAUTH_LOCAL_STORAGE_KEY);\n      }\n    }, 500);\n  };\n\n  if (!jwt) return null\n\n  const body = document.querySelector('body')\n  const iframeStyle =\n    'display:block; position:fixed; width:100%; height:100%; z-index:100; border:none; top:0; right:0'\n\n  const createIframe = (url, accountId, oauthConnectedAccount) => {\n    const iframeId = 'link-iframe'\n    const existingIframe = document.getElementById(iframeId)\n    if (!existingIframe) {\n      let additionalParamsStr = '';\n      if (additionalUrlParams) {\n        additionalParamsStr = Object.keys(additionalUrlParams).map(key =>\n          `&${key}=${additionalUrlParams[key]}\n        `).join('');\n      }\n      let urlWithParams = `${url}?jwt=${jwt}&accountId=${accountId}${additionalParamsStr}`;\n      if (oauthConnectedAccount) {\n        urlWithParams += `&${OAUTH_QUERY_PARAM}=${oauthConnectedAccount}`;\n      }\n\n      const iframe = document.createElement('iframe')\n      iframe.setAttribute('src', urlWithParams)\n      iframe.setAttribute('style', iframeStyle)\n      iframe.setAttribute('id', iframeId)\n      iframe.setAttribute('allow', 'camera');  // For QR-code scanning\n      body.appendChild(iframe);\n    }\n  }\n\n  const removeIframe = (event) => {\n    const iframe = document.querySelector('#link-iframe')\n    body.removeChild(iframe)\n    if (event.data.url) {\n      window.location = event.data.url\n    }\n\n    const endResult = event?.data?.endResult\n    if (endResult && cleanupActions[endResult]) {\n      cleanupActions[endResult]()\n    }\n  }\n\n  startOauthSuccessPolling();\n  startLocalStoragePolling();\n\n  window.onmessage = function (event) {\n    if (!Object.hasOwn(EVENT_MESSAGES, event.data.type)) {\n      return null\n    }\n\n    if (event?.data?.type === EVENT_MESSAGES.close) {\n      removeIframe(event);\n    } else if (event?.data?.type === EVENT_MESSAGES.redirect) {\n      window.location.replace(event.data.targetUrl);\n    } else {\n      createIframe(\n        new URL(EVENT_MESSAGES[event.data.type], url).href,\n        event.data.accountId,\n        event.data.oauthConnectedAccount\n      );\n    }\n  }\n\n  return null\n}\n"],"names":["EVENT_MESSAGES","linkConnect","verifyPhone","changePhone","enableTransfer","transferAssets","cryptoSavings","withdrawAssets","close","redirect","handleOpen","message","accountId","oauthConnectedAccount","Object","keys","includes","window","parent","postMessage","type","handleClose","endResult","handleRedirect","targetUrl","LinkModal","_ref","jwt","_ref$url","url","_ref$cleanupActions","cleanupActions","_ref$additionalUrlPar","additionalUrlParams","OAUTH_QUERY_PARAM","OAUTH_LOCAL_STORAGE_KEY","oauthPollingInterval","startOauthSuccessPolling","setInterval","params","URLSearchParams","location","search","maybeOauthConnectedAccount","get","localStorage","setItem","replace","origin","pathname","toString","startLocalStoragePolling","localStoragePollingInterval","getItem","currentUrl","URL","href","oauthQueryParamDeletedAlready","searchParams","has","createIframe","undefined","removeItem","body","document","querySelector","iframeStyle","iframeId","existingIframe","getElementById","additionalParamsStr","map","key","join","urlWithParams","iframe","createElement","setAttribute","appendChild","removeIframe","event","_event$data","removeChild","data","onmessage","_event$data2","_event$data3","hasOwn"],"mappings":"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"}